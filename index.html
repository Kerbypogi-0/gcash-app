<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gcash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0070BA, #005EA6);
            min-height: 100vh;
            color: white;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .search-bar {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 40px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .main-balance {
            text-align: center;
            padding: 40px 20px;
        }

        .currency-label {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            margin-bottom: 20px;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
        }

        .action-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .transactions-card {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            margin-top: 20px;
            min-height: 300px;
            color: #333;
        }

        .confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            max-width: 90%;
            width: 300px;
            text-align: center;
        }

        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .confirm-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .confirm-modal p {
            margin: 0 0 20px 0;
            color: #666;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .confirm-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .confirm-yes {
            background: #0070BA;
            color: white;
        }

        .confirm-no {
            background: #DC2626;
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-button {
            width: 100%;
            padding: 12px;
            background: #0070BA;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .transaction-amount {
            font-weight: bold;
        }

        .transaction-amount.negative {
            color: #DC2626;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 10px;
            background-color: white;
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .profile-modal {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rankings-container {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .rankings-title {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.25rem;
            font-weight: bold;
            position: sticky;
            top: 0;
            background: white;
        }

        .rankings-scroll {
            overflow-y: auto;
            flex-grow: 1;
            margin: 0 -20px;
            padding: 0 20px;
            scrollbar-width: thin;
            scrollbar-color: #0070BA #eee;
        }

        .rankings-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .rankings-scroll::-webkit-scrollbar-track {
            background: #eee;
            border-radius: 4px;
        }

        .rankings-scroll::-webkit-scrollbar-thumb {
            background: #0070BA;
            border-radius: 4px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .ranking-position {
            font-weight: bold;
            color: #0070BA;
            margin-right: 10px;
        }

        .ranking-details {
            text-align: right;
        }

        .ranking-total {
            font-weight: bold;
            color: #333;
        }

        .ranking-count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 4px;
        }

        .rankings-footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            position: sticky;
            bottom: 0;
            background: white;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        @media (max-width: 400px) {
            .transaction-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .transaction-header > div:last-child {
                margin-top: 5px;
            }
            
            .modal-button {
                font-size: 13px !important;
                padding: 6px !important;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="profile-icon" onclick="showProfileModal()">JS</div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search transactions..." onkeyup="searchTransactions()">
        </div>
    </div>

    <div class="main-balance">
        <div class="currency-label">Main ¬∑ PHP</div>
        <div class="balance-amount" id="currentBalance">‚Ç±0.00</div>
    </div>

    <div class="action-buttons">
        <button class="action-button" onclick="showAddMoneyModal()">
            <div class="action-icon">+</div>
            <span>Add money</span>
        </button>
        <button class="action-button" onclick="resetBalance()">
            <div class="action-icon">‚Üª</div>
            <span>Reset</span>
        </button>
        <button class="action-button" onclick="showTransactionModal()">
            <div class="action-icon">‚Üî</div>
            <span>Transaction</span>
        </button>
        <button class="action-button" onclick="showDetails()">
            <div class="action-icon">‚â°</div>
            <span>Details</span>
        </button>
        <button class="action-button" onclick="showRankings()">
            <div class="action-icon">üèÜ</div>
            <span>Rankings</span>
        </button>
    </div>

    <div class="transactions-card" id="transactionsList">
        <div style="text-align: center; color: #666;">No transactions yet</div>
    </div>

    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Set Initial Balance</h2>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="initialBalance" placeholder="Enter amount">
            </div>
            <button class="modal-button" onclick="setInitialBalance()">Set Balance</button>
            <button class="modal-button" style="background: #DC2626;" onclick="closeModal('addMoneyModal')">Cancel</button>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">New Transaction</h2>
            <div class="form-group">
                <label>Recipient Name</label>
                <input type="text" id="buyerName" placeholder="Enter recipient name">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="amount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Transaction Type</label>
                <select id="transactionType">
                    <option value="paid">Paid</option>
                    <option value="borrowed">Borrowed</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cash Flow</label>
                <select id="cashFlowType">
                    <option value="cashIn">Cash In</option>
                    <option value="cashOut">Cash Out</option>
                </select>
            </div>
            <button class="modal-button" onclick="addTransaction()">Add Transaction</button>
            <button class="modal-button" style="background: #DC2626;" onclick="closeModal('transactionModal')">Cancel</button>
        </div>
    </div>

    <div id="paymentModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 20px;">Make Payment</h2>
        <div class="form-group">
            <label>Payment Amount</label>
            <input type="number" id="paymentAmount" placeholder="Enter payment amount">
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <select id="paymentMethod">
                <option value="cash">Directly on Cash</option>
                <option value="ecash">E-Cash (Return to Balance)</option>
            </select>
        </div>
        <input type="hidden" id="currentTransactionIndex">
        <button class="modal-button" onclick="makePayment()">Submit Payment</button>
        <button class="modal-button" style="background: #DC2626;" onclick="closeModal('paymentModal')">Cancel</button>
    </div>
</div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content profile-modal">
            <h2 style="margin-bottom: 20px;">Profile Settings</h2>
            <div class="profile-form">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="profileName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" placeholder="Enter your email">
                </div>
                <button class="modal-button" onclick="saveProfile()">Save Profile</button>
                <button class="modal-button" style="background: #DC2626;" onclick="closeModal('profileModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rankings Modal -->
    <div id="rankingsModal" class="modal">
        <div class="modal-content rankings-container">
            <h2 class="rankings-title">Transaction Rankings</h2>
            <div class="rankings-scroll" id="rankingsList"></div>
            <div class="rankings-footer">
                <button class="modal-button" onclick="closeModal('rankingsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" style="display: none;">
        <div class="confirm-modal-backdrop"></div>
        <div class="confirm-modal">
            <h3 id="confirmTitle"></h3>
            <p id="confirmMessage"></p>
            <div class="confirm-buttons">
                <button class="confirm-button confirm-yes" id="confirmYes">Yes</button>
                <button class="confirm-button confirm-no" id="confirmNo">No</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentBalance = 0;
        let transactions = [];
        let historicalTransactions = [];
        let userProfile = {
            name: '',
            email: ''
        };

        function roundToTwoDecimals(number) {
            return Math.floor(number * 100) / 100;
        }

        function showAddMoneyModal() {
            document.getElementById('addMoneyModal').style.display = 'flex';
        }

        function showTransactionModal() {
            document.getElementById('transactionModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.backgroundColor = type === 'error' ? '#FEE2E2' : '#D1FAE5';
            notification.style.color = type === 'error' ? '#DC2626' : '#059669';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function formatCurrency(amount) {
            return '‚Ç±' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function updateBalanceDisplay() {
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
        }

        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.style.display = 'block';

            yesBtn.onclick = () => {
                modal.style.display = 'none';
                onConfirm();
            };

            noBtn.onclick = () => {
                modal.style.display = 'none';
            };

            // Close on backdrop click
            modal.querySelector('.confirm-modal-backdrop').onclick = () => {
                modal.style.display = 'none';
            };
        }

        function setInitialBalance() {
            const amount = parseFloat(document.getElementById('initialBalance').value);
            
            if (isNaN(amount) || amount < 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            // Get active borrowed transactions
            const activeBorrowed = getActiveBorrowedTransactions();
            
            // Calculate total borrowed amount
            const totalBorrowed = activeBorrowed.reduce((sum, t) => sum + t.remainingAmount, 0);
            
            // Check if new balance can cover borrowed amounts
            if (amount < totalBorrowed) {
                showNotification(
                    `New balance must be at least ${formatCurrency(totalBorrowed)} to cover existing borrowed amounts`,
                    'error'
                );
                return;
            }

            // If there's already a balance, show confirmation dialog
            if (currentBalance > 0) {
                showConfirmation(
                    'Confirm New Balance',
                    `Are you sure you want to set a new balance of ${formatCurrency(amount)}? Current transactions will be archived.`,
                    () => {
                        // Save non-borrowed transactions to history
                        if (transactions.length > 0) {
                            const nonBorrowedTransactions = transactions.filter(t => 
                                t.type !== 'borrowed' || t.remainingAmount === 0
                            );
                            
                            if (nonBorrowedTransactions.length > 0) {
                                const currentBatch = {
                                    date: new Date().toLocaleString(),
                                    initialBalance: currentBalance,
                                    transactions: nonBorrowedTransactions
                                };
                                historicalTransactions.unshift(currentBatch);
                            }
                        }
                        
                        // Keep active borrowed transactions
                        transactions = activeBorrowed;
                        currentBalance = amount;
                        updateBalanceDisplay();
                        document.getElementById('initialBalance').value = '';
                        closeModal('addMoneyModal');
                        
                        if (activeBorrowed.length > 0) {
                            showNotification(
                                `New balance set with ${activeBorrowed.length} borrowed transaction(s) retained`,
                                'success'
                            );
                        } else {
                            showNotification('Balance set successfully', 'success');
                        }
                        
                        updateTransactionsList();
                        saveData();
                    }
                );
            } else {
                showConfirmation(
                    'Confirm Initial Balance',
                    `Are you sure you want to set an initial balance of ${formatCurrency(amount)}?`,
                    () => {
                        // Keep active borrowed transactions
                        transactions = activeBorrowed;
                        currentBalance = amount;
                        updateBalanceDisplay();
                        document.getElementById('initialBalance').value = '';
                        closeModal('addMoneyModal');
                        
                        if (activeBorrowed.length > 0) {
                            showNotification(
                                `Initial balance set with ${activeBorrowed.length} borrowed transaction(s) retained`,
                                'success'
                            );
                        } else {
                            showNotification('Initial balance set successfully', 'success');
                        }
                        
                        updateTransactionsList();
                        saveData();
                    }
                );
            }
        }

        function resetBalance() {
            showConfirmation(
                'Confirm Reset',
                'Are you sure you want to reset your balance? Current transactions will be archived.',
                () => {
                    showConfirmation(
                        'Final Confirmation',
                        'This action cannot be undone. Do you really want to proceed?',
                        () => {
                            // Get active borrowed transactions before reset
                            const activeBorrowed = getActiveBorrowedTransactions();
                            
                            // Save non-borrowed transactions to historical transactions
                            if (transactions.length > 0) {
                                const nonBorrowedTransactions = transactions.filter(t => 
                                    t.type !== 'borrowed' || t.remainingAmount === 0
                                );
                                
                                if (nonBorrowedTransactions.length > 0) {
                                    const currentBatch = {
                                        date: new Date().toLocaleString(),
                                        initialBalance: currentBalance,
                                        transactions: nonBorrowedTransactions
                                    };
                                    historicalTransactions.unshift(currentBatch);
                                }
                            }

                            // Reset current balance
                            currentBalance = 0;
                            
                            // Clear current transactions but keep active borrowed ones
                            transactions = activeBorrowed;

                            // Update UI
                            updateBalanceDisplay();
                            updateTransactionsList();
                            saveData();
                            showNotification('Balance has been reset successfully', 'success');

                            // If there are active borrowed transactions, show a notification
                            if (activeBorrowed.length > 0) {
                                showNotification(
                                    `${activeBorrowed.length} borrowed transaction(s) retained`,
                                    'success'
                                );
                            }

                            // Ask if they want to set new balance
                            showConfirmation(
                                'Set New Balance',
                                'Would you like to set a new balance now?',
                                () => {
                                    showAddMoneyModal();
                                }
                            );
                        }
                    );
                }
            );
        }

        function getActiveBorrowedTransactions() {
            // Get borrowed transactions from current transactions
            const currentBorrowed = transactions.filter(t => 
                t.type === 'borrowed' && t.remainingAmount > 0
            );
            
            // Get borrowed transactions from historical transactions
            const historicalBorrowed = historicalTransactions.flatMap(batch => 
                batch.transactions.filter(t => 
                    t.type === 'borrowed' && t.remainingAmount > 0
                )
            );
            
            return [...currentBorrowed, ...historicalBorrowed];
        }

        function addTransaction() {
            const buyerName = document.getElementById('buyerName').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('transactionType').value;
            const cashFlowType = document.getElementById('cashFlowType').value;

            if (!buyerName) {
                showNotification('Please enter a recipient name', 'error');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            // For Cash In (deduct from balance), check if transaction amount exceeds current balance
            if (cashFlowType === 'cashIn' && amount > currentBalance) {
                showNotification(`Insufficient balance. Current balance: ${formatCurrency(currentBalance)}`, 'error');
                return;
            }

            const transaction = {
                buyerName,
                amount,
                date: new Date().toLocaleString(),
                type,
                cashFlowType, // Store the cash flow type
                remainingAmount: type === 'borrowed' ? amount : 0
            };

            transactions.unshift(transaction);
            
            // Update balance based on cash flow type
            if (cashFlowType === 'cashIn') {
                // Cash In: Subtract amount from balance
                currentBalance = currentBalance - amount;
            } else {
                // Cash Out: Add amount to balance
                currentBalance = currentBalance + amount;
            }
            
            updateBalanceDisplay();
            updateTransactionsList();
            closeModal('transactionModal');
            
            document.getElementById('buyerName').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('transactionType').selectedIndex = 0;
            document.getElementById('cashFlowType').selectedIndex = 0;
            
            showNotification('Transaction added successfully', 'success');
            saveData();
        }

        function showPaymentModal(transactionIndex) {
    const transaction = transactions[transactionIndex];
    document.getElementById('currentTransactionIndex').value = transactionIndex;
    document.getElementById('paymentAmount').value = transaction.remainingAmount;
    document.getElementById('paymentMethod').selectedIndex = 0; // Reset to default option
    document.getElementById('paymentModal').style.display = 'flex';
}

        function makePayment() {
    const transactionIndex = parseInt(document.getElementById('currentTransactionIndex').value);
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentMethod = document.getElementById('paymentMethod').value;
    const transaction = transactions[transactionIndex];

    if (isNaN(paymentAmount) || paymentAmount <= 0) {
        showNotification('Please enter a valid payment amount', 'error');
        return;
    }

    if (paymentAmount > transaction.remainingAmount) {
        showNotification('Payment amount cannot exceed remaining balance', 'error');
        return;
    }

    // Update the transaction
    transaction.remainingAmount -= paymentAmount;
    
    // If payment method is E-Cash, return the amount to balance
    if (paymentMethod === 'ecash') {
        currentBalance += paymentAmount;
        updateBalanceDisplay();
    }
    
    // If fully paid, update the type
    if (transaction.remainingAmount === 0) {
        transaction.type = 'paid';
        transaction.fullyPaidDate = new Date().toLocaleString();
    }

    // Add payment to the transaction's payment history if it doesn't exist
    if (!transaction.payments) {
        transaction.payments = [];
    }
    
    transaction.payments.push({
        amount: paymentAmount,
        date: new Date().toLocaleString(),
        method: paymentMethod === 'cash' ? 'Directly on Cash' : 'E-Cash'
    });

    // Update UI and save
    updateTransactionsList();
    saveData();
    closeModal('paymentModal');
    
    const methodText = paymentMethod === 'cash' ? 'cash payment' : 'e-cash payment (balance updated)';
    showNotification(`Payment recorded successfully via ${methodText}`, 'success');
}

        function deleteTransaction(index) {
            // Ask for confirmation before deleting
            showConfirmation(
                'Delete Transaction',
                'Are you sure you want to delete this transaction? The amount will be returned/removed from your balance.',
                () => {
                    const transaction = transactions[index];
                    
                    // If it's a borrowed transaction
                    if (transaction.type === 'borrowed' && transaction.remainingAmount > 0) {
                        // Return only the remaining amount to the balance or deduct from balance
                        if (transaction.cashFlowType === 'cashIn') {
                            // Cash In: Return the remaining amount
                            currentBalance += transaction.remainingAmount;
                        } else {
                            // Cash Out: Deduct the remaining amount
                            currentBalance -= transaction.remainingAmount;
                        }
                    } 
                    // If it's a paid transaction or fully paid borrowed transaction
                    else {
                        // Return the full amount to the balance or deduct from balance
                        if (transaction.cashFlowType === 'cashIn') {
                            // Cash In: Return the amount
                            currentBalance += transaction.amount;
                        } else {
                            // Cash Out: Deduct the amount
                            currentBalance -= transaction.amount;
                        }
                    }
                    
                    // Remove the transaction from the array
                    transactions.splice(index, 1);
                    
                    // Update the UI
                    updateBalanceDisplay();
                    updateTransactionsList();
                    saveData();
                    
                    showNotification('Transaction deleted successfully', 'success');
                }
            );
        }

        function updateTransactionsList(filteredTransactions = transactions) {
    const transactionsList = document.getElementById('transactionsList');
    
    if (filteredTransactions.length === 0) {
        transactionsList.innerHTML = '<div style="text-align: center; color: #666;">No transactions yet</div>';
        return;
    }

    transactionsList.innerHTML = filteredTransactions.map((transaction, index) => {
        // Build payment history display
        let paymentHistoryHTML = '';
        if (transaction.payments && transaction.payments.length > 0) {
            paymentHistoryHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
                    <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">Payment History:</div>
                    ${transaction.payments.map(payment => `
                        <div style="font-size: 11px; color: #666; margin-bottom: 2px;">
                            ${formatCurrency(payment.amount)} - ${payment.method} (${payment.date})
                        </div>
                    `).join('')}
                </div>
            `;
        }

        return `
            <div class="transaction-item">
                <div class="transaction-header">
                    <div>${transaction.buyerName}</div>
                    <div>
                        <div class="transaction-amount ${transaction.cashFlowType === 'cashIn' ? 'negative' : ''}">
                            ${transaction.cashFlowType === 'cashIn' ? '-' : '+'} ${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                </div>
                <div class="transaction-date">${transaction.date}</div>
                <div style="color: ${transaction.type === 'paid' ? '#059669' : '#DC2626'}">
                    ${transaction.type === 'paid' ? 'Paid' : 'Borrowed'} ¬∑ 
                    ${transaction.cashFlowType === 'cashIn' ? 'Cash In' : 'Cash Out'}
                </div>
                ${paymentHistoryHTML}
                ${transaction.type === 'borrowed' && transaction.remainingAmount > 0 ? `
                    <div style="margin-top: 10px;">
                        <div>Remaining: ${formatCurrency(transaction.remainingAmount)}</div>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <button 
                                class="modal-button" 
                                style="flex: 1; padding: 8px; font-size: 14px;"
                                onclick="showPaymentModal(${index})"
                            >
                                Make Payment
                            </button>
                            <button 
                                class="modal-button" 
                                style="flex: 1; padding: 8px; background: #DC2626; font-size: 14px;"
                                onclick="deleteTransaction(${index})"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                ` : `
                    <div style="margin-top: 10px;">
                        <button 
                            class="modal-button" 
                            style="width: 100%; padding: 8px; background: #DC2626; font-size: 14px;"
                            onclick="deleteTransaction(${index})"
                        >
                            Delete
                        </button>
                    </div>
                `}
            </div>
        `;
    }).join('');
}
        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileEmail').value = userProfile.email;
        }

    function saveProfile() {
        userProfile.name = document.getElementById('profileName').value;
        userProfile.email = document.getElementById('profileEmail').value;
        
        // Set icon text based on user's name (first letter of first and last name)
        updateProfileIcon();
        
        // Save to local storage
        saveData();
        closeModal('profileModal');
        showNotification('Profile saved successfully', 'success');
    }

    function updateProfileIcon() {
        const profileIcon = document.querySelector('.profile-icon');
        if (userProfile.name) {
            const nameParts = userProfile.name.split(' ');
            if (nameParts.length > 1) {
                profileIcon.textContent = nameParts[0][0] + nameParts[nameParts.length - 1][0];
            } else {
                profileIcon.textContent = nameParts[0][0];
            }
        } else {
            profileIcon.textContent = 'JS'; // Default
        }
    }

    function searchTransactions() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
            updateTransactionsList(); // Show all transactions
            return;
        }

        const filtered = transactions.filter(transaction => 
            transaction.buyerName.toLowerCase().includes(searchTerm) || 
            transaction.amount.toString().includes(searchTerm) ||
            transaction.date.toLowerCase().includes(searchTerm)
        );

        updateTransactionsList(filtered);
    }

    function showDetails() {
        // Create a modal with transaction history and charts
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const transactionCount = transactions.length;
        const totalPaid = transactions
            .filter(t => t.type === 'paid')
            .reduce((sum, t) => sum + t.amount, 0);
        const totalBorrowed = transactions
            .filter(t => t.type === 'borrowed')
            .reduce((sum, t) => sum + t.amount, 0);
        const activeBorrowed = transactions
            .filter(t => t.type === 'borrowed' && t.remainingAmount > 0)
            .reduce((sum, t) => sum + t.remainingAmount, 0);

        // Create historical details
        let historicalHTML = '';
        if (historicalTransactions.length > 0) {
            historicalHTML = `
                <h3 style="margin-top: 20px;">Historical Transactions</h3>
                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    ${historicalTransactions.map((batch, index) => `
                        <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <div><strong>Date:</strong> ${batch.date}</div>
                            <div><strong>Initial Balance:</strong> ${formatCurrency(batch.initialBalance)}</div>
                            <div><strong>Transactions:</strong> ${batch.transactions.length}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <h2 style="margin-bottom: 20px;">Transaction Details</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666;">Current Balance</div>
                        <div style="font-size: 20px; font-weight: bold;">${formatCurrency(currentBalance)}</div>
                    </div>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666;">Transactions</div>
                        <div style="font-size: 20px; font-weight: bold;">${transactionCount}</div>
                    </div>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666;">Total Paid</div>
                        <div style="font-size: 20px; font-weight: bold;">${formatCurrency(totalPaid)}</div>
                    </div>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666;">Active Borrowed</div>
                        <div style="font-size: 20px; font-weight: bold;">${formatCurrency(activeBorrowed)}</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Transaction Analysis</h3>
                    <canvas id="transactionChart" width="400" height="200"></canvas>
                </div>

                ${historicalHTML}
                
                <button class="modal-button" style="margin-top: 20px;" onclick="this.parentElement.parentElement.remove()">
                    Close
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Create chart
        setTimeout(() => {
            const ctx = document.getElementById('transactionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Paid', 'Total Borrowed', 'Active Borrowed'],
                    datasets: [{
                        label: 'Transaction Amounts',
                        data: [totalPaid, totalBorrowed, activeBorrowed],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }, 100);
    }

    function showRankings() {
        // Get all transaction recipients
        const recipients = {};
        
        // Process current transactions
        transactions.forEach(transaction => {
            const name = transaction.buyerName;
            if (!recipients[name]) {
                recipients[name] = {
                    totalAmount: 0,
                    count: 0
                };
            }
            recipients[name].totalAmount += transaction.amount;
            recipients[name].count++;
        });
        
        // Process historical transactions
        historicalTransactions.forEach(batch => {
            batch.transactions.forEach(transaction => {
                const name = transaction.buyerName;
                if (!recipients[name]) {
                    recipients[name] = {
                        totalAmount: 0,
                        count: 0
                    };
                }
                recipients[name].totalAmount += transaction.amount;
                recipients[name].count++;
            });
        });
        
        // Convert to array and sort by total amount
        const rankingsArray = Object.keys(recipients).map(name => ({
            name,
            totalAmount: recipients[name].totalAmount,
            count: recipients[name].count
        })).sort((a, b) => b.totalAmount - a.totalAmount);
        
        // Display rankings in modal
        const rankingsList = document.getElementById('rankingsList');
        rankingsList.innerHTML = rankingsArray.map((item, index) => `
            <div class="ranking-item">
                <div>
                    <span class="ranking-position">#${index + 1}</span>
                    <span>${item.name}</span>
                </div>
                <div class="ranking-details">
                    <div class="ranking-total">${formatCurrency(item.totalAmount)}</div>
                    <div class="ranking-count">${item.count} transaction${item.count !== 1 ? 's' : ''}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('rankingsModal').style.display = 'flex';
    }

    function saveData() {
        localStorage.setItem('gcashAppBalance', currentBalance);
        localStorage.setItem('gcashAppTransactions', JSON.stringify(transactions));
        localStorage.setItem('gcashAppHistoricalTransactions', JSON.stringify(historicalTransactions));
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
    }

    function loadData() {
        // Load balance
        const savedBalance = localStorage.getItem('gcashAppBalance');
        if (savedBalance !== null) {
            currentBalance = parseFloat(savedBalance);
            updateBalanceDisplay();
        }
        
        // Load transactions
        const savedTransactions = localStorage.getItem('gcashAppTransactions');
        if (savedTransactions) {
            transactions = JSON.parse(savedTransactions);
            updateTransactionsList();
        }
        
        // Load historical transactions
        const savedHistorical = localStorage.getItem('gcashAppHistoricalTransactions');
        if (savedHistorical) {
            historicalTransactions = JSON.parse(savedHistorical);
        }
        
        // Load user profile
        const savedProfile = localStorage.getItem('userProfile');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            updateProfileIcon();
        }
    }

    // Initialize on page load
    window.onload = function() {
        loadData();
    };
</script>
</body>
</html>
